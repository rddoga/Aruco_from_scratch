<!DOCTYPE html>
<html>
<head>

  <meta charset="UTF-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
  <style>
  
.slider {
  width: 400px;
}
.split {
  height: 100%;
  width: 50%;
  position: fixed;
  z-index: 1;
  top: 0;
  overflow-x: hidden;
  padding-top: 20px;
}

.left {
  left: 0;
  background-color: #FFFAFA;
}

.right {
  right: 0;
}

  </style>
  <title>JSMpeg Stream Client</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic"> </link>
  
</head>


<body>

<!-- Left side of the screen -->
<div class="split left" style="padding-left:20px"> 
  <h1>Video Streaming with GStreamer and WebSocket</h1>

	<div>
		        
	  <canvas id="video-canvas" width="640" height="480" style="float:left; border:2px solid black"></canvas> 

	</div>
</div>

<!-- Right side of the screen -->
<div class="split right">
	<div class="tabs three">
	  <input id='tab-1' type='radio' name='tabgroupB' checked="checked" />
	  <label class="pseudo button toggle" for="tab-1">Video Stream</label>
	  <input id='tab-2' type='radio' name='tabgroupB' />
	  <label class="pseudo button toggle" for="tab-2">Points</label>
	  <input id='tab-3' type='radio' name='tabgroupB' />
	  <label class="pseudo button toggle" for="tab-3">Detection</label>
	  <div class="row">
	<!--First Tab for Video Streaming-->
			<div>
				  <!--<h1>Video Streaming with GStreamer and WebSocket</h1>-->
				  
			  <div class="flex two demo" style="padding:20px">
			    
			    <div>
				    <article class="card" style="padding:10px" > 
							<input type="radio" id="Real Image" name="output" value="Real" onchange="sendDataRadio()" checked="checked" />
							<label for="Real Image" class="checkable">Real Image</label><br />
							<input type="radio" id="Binary Image" name="output" value="Bin" onchange="sendDataRadio()"/>
							<label for="Binary Image" class="checkable">Binary Image</label><br />
							<input type="radio" id="No Image" name="output" value="Inactive" onchange="sendDataRadio()"/>
							<label for="No Image" class="checkable">No Video</label><br /> 
					  </article>
					</div>
					
					<div>
				    <article class="card" style="padding:10px" > 
				      
						<div id="SliderChange"> Tooltip zOffset</div>
						<input type="range" class="slider" id="zOffset" name="zOffset" min="0" max="2000" step="1" value="350" onchange="updateSlider(this.value, this.name)" oninput="num.value = this.value"/>
						<output id="num">350</output> 
					 
						<div id="SliderChange"> Exposure Time </div>
						<input type="range" class="slider" id="ExposureTime" name="Exposure_Time" min="1000" max="15000" step="1000" onchange="updateSlider(this.value, this.name)"/>
						
						<div id="SliderChange"> Gain </div>
						<input type="range" class="slider" id="Gain" name="Gain" min="0" max="27" step="1" onchange="updateSlider(this.value, this.name)"/>
						
						<div id="SliderChange"> Threshold </div>
						<input type="range" class="slider" id="Thresh" name="Threshold" min="0" max="255" step="1" onchange="updateSlider(this.value, this.name)"/>
					
						</article>
			  
			  	</div>
			  	
				</div>
			</div>

		<!--Second tab for Point registration/detection -->
			<div style="padding:20px">

			 
				<!--<div class="flex two demo" style="padding:20px">
				
			 For diplaying video 
				  <div>
				    <article class="card" > 
				      <header> VIDEO </header>   
				      <section>  
				        <canvas id="video-canvas" width="480" height="320" style="border:2px solid green"></canvas>
				      </section> 
				    </article>
				  </div>--> 
	  
				  
			<!--For Registering/Erasing points -->   
				  <div>
				    <article class="card" > 
				      <header> ACTIONS </header> 
				      
				      <section style="padding-left:20px">
				      
				        <div class="flex five demo" >
				          <div><button id="Origin" class='success' onclick="sendDataBasis('RegOrigin')">Register Origin</button></div>
				          <div><button id="XAxis" class='success' onclick="sendDataBasis('RegXAxis')">Place X axis</button></div>
				          <div><button id="YAxis" class='success' onclick="sendDataBasis('RegYAxis')">Place Y axis</button></div>
				          <div class="off-fifth"><button id="Restart" onclick="sendData('RestartAll')">Restart over</button></div>
				        </div>
				        <div class="flex two demo" >
				          <div>
				            <button onclick="sendData('RegPoint')">Register Point</button>
				          </div>
				          <div align="right">
				          	<button class='error' onclick="sendData('RemoveLastP')">Remove last registered</button>
				          </div>
				        </div> 
			          <div>
			          	<button class='warning' onclick="sendData('RegErrMarginX')">Register X error</button>
			            <button class='warning' onclick="sendData('RegErrMarginY')">Register Y error</button>
			            <button class='warning' onclick="sendData('RegErrMarginZ')">Register Z error</button>
			          </div>

				      </section> 
				    </article>
				  </div>
				  
				  	  
			 <!--For displaying point coordinates (10 points MAX For now) -->    
				  <div>
				  
				    <article class="card" > 
				    
				      <header> REGISTERED POINTS </header>   
		          <table class="primary">
		            <thead>
		              <tr>
		                <th>Point ID</th>
		                <th style="width:35%">Coordinates</th>
		                <th>X Error Margin </th>
		                <th>Y Error Margin </th>
		                <th>Z Error Margin </th><!---->
		              </tr>
		            </thead>
		            <tbody>
		              <tr id="P1" hidden="hidden">
		                <td>1</td>
		                <td id="coord1">[P1] </td>
		                <td id="Xerror1">[ErrX]</td>
		                <td id="Yerror1">[ErrY]</td>
		                <td id="Zerror1">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P2" hidden="hidden">
		                <td>2</td>
		                <td id="coord2">[P2]</td>
		                <td id="Xerror2">[ErrX]</td>
		                <td id="Yerror2">[ErrY]</td>
		                <td id="Zerror2">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P3" hidden="hidden">
		                <td>3</td>
		                <td id="coord3">[P3]</td>
		                <td id="Xerror3">[ErrX]</td>
		                <td id="Yerror3">[ErrY]</td>
		                <td id="Zerror3">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P4" hidden="hidden">
		                <td>4</td>
		                <td id="coord4">[P4]</td>
		                <td id="Xerror4">[ErrX]</td>
		                <td id="Yerror4">[ErrY]</td>
		                <td id="Zerror4">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P5" hidden="hidden">
		                <td>5</td>
		                <td id="coord5">[P5]</td>
		                <td id="Xerror5">[ErrX]</td>
		                <td id="Yerror5">[ErrY]</td>
		                <td id="Zerror5">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P6" hidden="hidden">
		                <td>5</td>
		                <td id="coord6">[P6]</td>
		                <td id="Xerror6">[ErrX]</td>
		                <td id="Yerror6">[ErrY]</td>
		                <td id="Zerror6">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P7" hidden="hidden">
		                <td>5</td>
		                <td id="coord7">[P7]</td>
		                <td id="Xerror7">[ErrX]</td>
		                <td id="Yerror7">[ErrY]</td>
		                <td id="Zerror7">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P8" hidden="hidden">
		                <td>5</td>
		                <td id="coord8">[P8]</td>
		                <td id="Xerror8">[ErrX]</td>
		                <td id="Yerror8">[ErrY]</td>
		                <td id="Zerror8">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P9" hidden="hidden">
		                <td>5</td>
		                <td id="coord9">[P9]</td>
		                <td id="Xerror9">[ErrX]</td>
		                <td id="Yerror9">[ErrY]</td>
		                <td id="Zerror9">[ErrZ]</td><!---->
		              </tr>
		              <tr id="P10" hidden="hidden">
		                <td>5</td>
		                <td id="coord10">[P10]</td>
		                <td id="Xerror10">[ErrX]</td>
		                <td id="Yerror10">[ErrY]</td>
		                <td id="Zerror10">[ErrZ]</td><!---->
		              </tr>
		            </tbody>
		          </table>
				    </article>
				    
				  </div>
				  
			<!--For Detecting Points -->    
				  <div>
				    
				  </div>
				  	
				  
				<!--</div>-->
			</div>

		<!-- Third tab for ... -->
			<div style="padding:20px">
				<article class="card" > 
		      <header> DETECTED POINT </header>  
		      
		      <section>
		        <strong id="DetectedPoint" style="color:red;font-size:50px;font-family:Arial;padding:50px;">No Point Detected </strong>
		        
		       <!-- <button class="error" onclick="clearInterval(myVar)">Stop detecting</button> -->
		        
		      </section>
		    </article>
			</div>
		
	  </div>
	  
	</div>
	
</div>


<!--------------------------------------
--------------SCRIPTS-------------------
---------------------------------------->

  <!--For displaying the image-->
  <script type="text/javascript" src="static/jsmpeg.min.js"></script>
  <script type="text/javascript"> 
        var canvas = document.getElementById('video-canvas');
	    var url = 'ws://'+document.location.hostname+':8082/';
	    var player = new JSMpeg.Player(url, {canvas: canvas});
	
    
  </script>


  <!-- Script executed when changing view on the radio button -->
  <script>

function sendDataRadio() {
  var XHR = new XMLHttpRequest();
  var urlEncodedData = "";
  var urlEncodedDataPairs = [];
  var name;

  var getSelectedValue = document.querySelector('input[name="output"]:checked'); 
                
  // Transformez l'objet data en un tableau de paires clé/valeur codées URL.
  //for(name in data) {
  urlEncodedDataPairs.push(encodeURIComponent(getSelectedValue.name) + '=' + encodeURIComponent(getSelectedValue.value));
  //}

  // Combinez les paires en une seule chaîne de caractères et remplacez tous
  // les espaces codés en % par le caractère'+' ; cela correspond au comportement
  // des soumissions de formulaires de navigateur.
  urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');


  /////////////Sending with Get :
  // Configurez la requête (GET)
  XHR.open('GET', '/DataEx?' + urlEncodedData);
  
  // Finalement, envoyez les données.
  XHR.send();

  //Hide the video if "No Video" selected on the radio button
  if(getSelectedValue.value == "Inactive" ){
    canvas.setAttribute("hidden","hidden");
  }
  else{
    canvas.removeAttribute("hidden");
  }
}

  </script>

  
  <!-- Script executed on slider update -->
  <script> 
function updateSlider(slideAmount, sliderName) {
    var XHR = new XMLHttpRequest();
    var urlEncodedData = "";
    var urlEncodedDataPairs = [];

                
    // Transformez l'objet data en un tableau de paires clé/valeur codées URL.
    //for(name in data) {
    urlEncodedDataPairs.push(encodeURIComponent(sliderName) + '=' + encodeURIComponent(slideAmount));
    //}

    // Combinez les paires en une seule chaîne de caractères et remplacez tous
    // les espaces codés en % par le caractère'+' ; cela correspond au comportement
    // des soumissions de formulaires de navigateur.
    urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');


    /////////////Sending with Get :
    // Configurez la requête (GET)
    XHR.open('GET', '/DataEx?' + urlEncodedData);

    // Finalement, envoyez les données.
    XHR.send();
}
  </script> 
  
  
<!-- Script executed on Origin/axis registration request  -->
  <script>
  
//Basis Registration and response from the server (for displaying what point of the basis is to be displayed next)
function sendDataBasis(Step) {
  var XHR = new XMLHttpRequest();
  var urlEncodedData = "";
  var urlEncodedDataPairs = []; 
                
  // Créer un tableau de paires clé/valeur codées URL.
  urlEncodedDataPairs.push(encodeURIComponent(Step) + '=' + encodeURIComponent("true"));


  // Combinez les paires en une seule chaîne de caractères et remplacez tous
  // les espaces codés en % par le caractère'+' ; cela correspond au comportement
  // des soumissions de formulaires de navigateur.
  urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

  //Function that will catch the response from the server
  XHR.onreadystatechange = function() {
    console.log("onreadystatechange - XHR.responseText: " + XHR.responseText);
    
    //If we just registered the origin, register the X axis (display info in button text)
    if(XHR.responseText == 1){
      document.getElementById("Origin").innerHTML = "Done.";
      document.getElementById("Origin").disabled = true;
    }
    //If we just registered the X axis, register the Y axis (display info in button text)
    else if(XHR.responseText == 2){
      document.getElementById("XAxis").innerHTML = "Done.";
      document.getElementById("XAxis").disabled = true;
    }
    //If we are finished, disable button
    else if(XHR.responseText == 3){
      document.getElementById("YAxis").innerHTML = "Done.";
      document.getElementById("YAxis").disabled = true;
    }
  }
  
  /////////////Sending with Get :
  // Configurez la requête (GET)
  XHR.open('GET', '/DataEx?' + urlEncodedData);
  
  // Finalement, envoyez les données.
  XHR.send();
  
}  
  
  </script>  

  
    
<!-- Script executed on point registration/error margin registration/relative Basis registration/point deletion .... requests -->  
  <script>
function sendData(type) {
  var XHR = new XMLHttpRequest();
  var urlEncodedData = "";
  var urlEncodedDataPairs = []; 
                
  // Créer un tableau de paires clé/valeur codées URL.
  urlEncodedDataPairs.push(encodeURIComponent(type) + '=' + encodeURIComponent("true"));


  // Combinez les paires en une seule chaîne de caractères et remplacez tous
  // les espaces codés en % par le caractère'+' ; cela correspond au comportement
  // des soumissions de formulaires de navigateur.
  urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
  
	console.log("Sending");
	//Function that will catch the response from the server
	XHR.onreadystatechange = function() {
	  console.log("onreadystatechange - XHR.responseText: " + XHR.response);
	  //document.getElementById("test").innerHTML = XHR.response;
	  
	  //Stop if the response is empty
		if(XHR.response === ""){
			return;
		}
	
//Parse the JSON received String to Javascript variables
	  const ResReceived = JSON.parse(XHR.response);
	  console.log("onreadystatechange - ResReceived: " + ResReceived.coordinates);
	  
	  //Checking if we added or deleted a point
	  //Adding point
	  if(ResReceived.action === "addition"){
	    document.getElementById("coord" + ResReceived.id).innerHTML = "[ " + ResReceived.coordinates[0].toFixed(2) + "; " + ResReceived.coordinates[1].toFixed(2) + "; " + ResReceived.coordinates[2].toFixed(2) + " ]";
	    document.getElementById("P" + ResReceived.id).hidden = false;
	  }
	  
	  //Adding X error margin to the table
	  else if(ResReceived.action === "addition X err"){
	    
	    document.getElementById("Xerror" + ResReceived.id).innerHTML = ResReceived.errorMarginX.toFixed(2);
	  }
	  //Adding Y error margin to the table
	  else if(ResReceived.action === "addition Y err"){
	    
	    document.getElementById("Yerror" + ResReceived.id).innerHTML = ResReceived.errorMarginY.toFixed(2);
	  }
	  //Adding Z error margin to the table
	  else if(ResReceived.action === "addition Z err"){
	    
	    document.getElementById("Zerror" + ResReceived.id).innerHTML = ResReceived.errorMarginZ.toFixed(2);
	  }
	  
	  //Deleting point
	  else if(ResReceived.action === "deletion"){
	    document.getElementById("coord" + ResReceived.id).innerHTML = "";
	    document.getElementById("Xerror" + ResReceived.id).innerHTML = "";
	    document.getElementById("Yerror" + ResReceived.id).innerHTML = "";
	    document.getElementById("Zerror" + ResReceived.id).innerHTML = "";
	    document.getElementById("P" + ResReceived.id).hidden = true;
	  }
	  
	  //Check if we detected a point
	  else if(ResReceived.action === "CheckDetect"){
	  
	    //Print the ID if we are detecting a point
	    if(ResReceived.id > 0){
	      document.getElementById("DetectedPoint").innerHTML = "ID : " + ResReceived.id ;
	      document.getElementById("DetectedPoint").style = "color:green;font-size:50px;padding:50px;";
	    }else{
	      document.getElementById("DetectedPoint").innerHTML = "No point detected." ;
	      document.getElementById("DetectedPoint").style = "color:red;font-size:50px;padding:50px;";
	    }      
	  }
	  
	  
	  //
	  else if(ResReceived.action === "RestartAll"){
		window.location.reload();
		return false;
	  }
	  
	  else if(ResReceived.ok === true)
	  {
	 	  console.log("Responded OK but no action completed");
	  }

	}
	
	/////////////Sending with Get :
	// Configurez la requête (GET)
	XHR.open('GET', '/DataEx?' + urlEncodedData);
	
	// Finalement, envoyez les données.
	XHR.send();

}  


  </script>
 
 <!--script executed every second that checks if a point has been detected -->
  <script>
  
let myVar = setInterval(sendDetectedCheck, 1000);
  
function sendDetectedCheck() {

  //const d = new Date();
  //document.getElementById("test").innerHTML = d.toLocaleTimeString();
  
  var XHR = new XMLHttpRequest();
  var urlEncodedData = "";
  var urlEncodedDataPairs = []; 
                
  // Créer un tableau de paires clé/valeur codées URL.
  urlEncodedDataPairs.push(encodeURIComponent("Detected") + '=' + encodeURIComponent("true"));


  // Combinez les paires en une seule chaîne de caractères et remplacez tous
  // les espaces codés en % par le caractère'+' ; cela correspond au comportement
  // des soumissions de formulaires de navigateur.
  urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
  //console.log("oui oui");

  //Function that will catch the response from the server
  XHR.onreadystatechange = function() {
    console.log("onreadystatechange - XHR.responseText: " + XHR.response);
    
	//Stop if the response is empty
	if(XHR.response === ""){
		return;
	}

    //Parse the JSON received String to Javascript variables 
    const ResReceived = JSON.parse(XHR.response);
    //console.log("onreadystatechange - ResReceived: " + ResReceived.coordinates);
    
    //Check if we receive the response giving the id
    if(ResReceived.action === "CheckDetect"){
      //Print the ID if we are detecting a point
      if(ResReceived.id > 0){
        document.getElementById("DetectedPoint").innerHTML = "ID : " + ResReceived.id ;
        document.getElementById("DetectedPoint").style = "color:green;font-size:50px;padding:50px;";
      }else{
        document.getElementById("DetectedPoint").innerHTML = "No point detected." ;
        document.getElementById("DetectedPoint").style = "color:red;font-size:50px;padding:50px;";
      }
    }
  }
  
  /////////////Sending with Get :
  // Configurez la requête (GET)
  XHR.open('GET', '/DataEx?' + urlEncodedData);
  
  // Finalement, envoyez les données.
  XHR.send();
}

  </script>


</body>
</html>
